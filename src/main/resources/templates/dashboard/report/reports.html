<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports - Blackdot EMS</title>
    <link rel="stylesheet" th:href="@{/css/admin-pages.css}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Header -->
    <div th:replace="~{layout/admin-layout :: header}"></div>

    <!-- Sidebar Navigation -->
    <div th:replace="~{layout/admin-layout :: sidebar('reports')}"></div>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Page Header -->
        <div class="page-header">
            <div class="page-header-content">
                <div>
                    <h2 class="page-title">Reports & Analytics</h2>
                    <p class="page-subtitle">Generate reports and view analytics for employees and assessments</p>
                </div>
            </div>
        </div>

        <!-- Report Generation Cards -->
        <div class="reports-grid">
            <!-- Employee Reports -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-users"></i> Employee Reports</h3>
                </div>
                <div class="card-body">
                    <p class="card-description">Generate comprehensive employee reports with all active employees, their roles, and basic information.</p>
                    <div class="btn-group">
                        <button onclick="generateEmployeeReport('pdf')" class="btn btn-success">
                            <i class="fas fa-file-pdf"></i> PDF Report
                        </button>
                        <button onclick="generateEmployeeReport('excel')" class="btn btn-warning">
                            <i class="fas fa-file-excel"></i> Excel Report
                        </button>
                    </div>
                </div>
            </div>

            <!-- Quarterly Assessment Reports -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-clipboard-list"></i> Assessment Reports</h3>
                </div>
                <div class="card-body">
                    <p class="card-description">Generate quarterly assessment reports with performance analytics.</p>
                    <div class="form-group mb-2">
                        <select id="quarterSelect" class="form-control">
                            <option value="Q1">Q1 - January to March</option>
                            <option value="Q2">Q2 - April to June</option>
                            <option value="Q3">Q3 - July to September</option>
                            <option value="Q4" selected>Q4 - October to December</option>
                        </select>
                    </div>
                    <div class="form-group mb-3">
                        <select id="yearSelect" class="form-control">
                            <option value="2025" selected>2025</option>
                            <option value="2024">2024</option>
                            <option value="2023">2023</option>
                        </select>
                    </div>
                    <div class="btn-group">
                        <button onclick="generateQuarterlyReport('pdf')" class="btn btn-success">
                            <i class="fas fa-file-pdf"></i> PDF Report
                        </button>
                        <button onclick="generateQuarterlyReport('excel')" class="btn btn-warning">
                            <i class="fas fa-file-excel"></i> Excel Report
                        </button>
                    </div>
                </div>
            </div>

            <!-- Employee Assessment History -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-history"></i> Employee History</h3>
                </div>
                <div class="card-body">
                    <p class="card-description">Generate individual employee assessment history reports.</p>
                    <div class="form-group mb-3">
                        <input type="text" id="employeeIdInput" placeholder="Enter Employee ID" class="form-control">
                    </div>
                    <div class="btn-group">
                        <button onclick="generateEmployeeHistory('pdf')" class="btn btn-success">
                            <i class="fas fa-file-pdf"></i> PDF Report
                        </button>
                        <button onclick="generateEmployeeHistory('excel')" class="btn btn-warning">
                            <i class="fas fa-file-excel"></i> Excel Report
                        </button>
                    </div>
                </div>
            </div>

            <!-- All Tasks Report -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-tasks"></i> Task Reports</h3>
                </div>
                <div class="card-body">
                    <p class="card-description">Generate comprehensive task reports with all tasks, status, and assignment information.</p>
                    <div class="btn-group">
                        <button onclick="generateTaskReport('pdf')" class="btn btn-success">
                            <i class="fas fa-file-pdf"></i> PDF Report
                        </button>
                        <button onclick="generateTaskReport('excel')" class="btn btn-warning">
                            <i class="fas fa-file-excel"></i> Excel Report
                        </button>
                    </div>
                </div>
            </div>

            <!-- Employee Task History -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-user-clock"></i> Employee Task History</h3>
                </div>
                <div class="card-body">
                    <p class="card-description">Generate individual employee task history and performance reports.</p>
                    <div class="form-group mb-3">
                        <input type="text" id="taskEmployeeIdInput" placeholder="Enter Employee ID" class="form-control">
                    </div>
                    <div class="btn-group">
                        <button onclick="generateEmployeeTaskHistory('pdf')" class="btn btn-success">
                            <i class="fas fa-file-pdf"></i> PDF Report
                        </button>
                        <button onclick="generateEmployeeTaskHistory('excel')" class="btn btn-warning">
                            <i class="fas fa-file-excel"></i> Excel Report
                        </button>
                    </div>
                </div>
            </div>

            <!-- Analytics Dashboard -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-chart-line"></i> Live Analytics</h3>
                </div>
                <div class="card-body">
                    <p class="card-description">View real-time analytics for current quarter assessments.</p>
                    <button onclick="loadAnalytics()" class="btn btn-primary">
                        <i class="fas fa-chart-line"></i> Load Analytics
                    </button>
                </div>
            </div>
        </div>

        <!-- Analytics Section -->
        <div id="analyticsSection" style="display: none;">
            <div class="card mb-3">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-chart-line"></i> Assessment Analytics</h3>
                </div>
                <div class="card-body">
                    <!-- Statistics Cards -->
                    <div id="analyticsStats" class="stats-grid">
                        <!-- Statistics will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="charts-grid">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-chart-bar"></i> Score Distribution</h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="scoreDistributionChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-building"></i> Department Performance</h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="departmentChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Reports Table -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-clock"></i> Quick Actions</h3>
            </div>
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Report Type</th>
                            <th>Description</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><i class="fas fa-users"></i> All Employees</td>
                            <td>Complete employee list with roles and status</td>
                            <td class="text-center">
                                <button onclick="generateEmployeeReport('pdf')" class="btn btn-success">
                                    <i class="fas fa-download"></i> PDF
                                </button>
                            </td>
                        </tr>
                        <tr>
                            <td><i class="fas fa-clipboard-list"></i> Current Quarter</td>
                            <td>Assessment results for Q4 2025</td>
                            <td class="text-center">
                                <button onclick="generateCurrentQuarterReport()" class="btn btn-success">
                                    <i class="fas fa-download"></i> PDF
                                </button>
                            </td>
                        </tr>
                        <tr>
                            <td><i class="fas fa-chart-bar"></i> Analytics Dashboard</td>
                            <td>Real-time performance metrics and charts</td>
                            <td class="text-center">
                                <button onclick="loadAnalytics()" class="btn btn-warning">
                                    <i class="fas fa-eye"></i> View
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/login';
        }

        async function generateEmployeeReport(format) {
            try {
                showNotification('Generating employee report...', 'info');
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/reports/employees?format=${format}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `employee-report.${format === 'pdf' ? 'pdf' : 'xls'}`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    showNotification('Employee report generated successfully!', 'success');
                } else {
                    showNotification('Failed to generate employee report', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('Network error generating report', 'error');
            }
        }

        async function generateQuarterlyReport(format) {
            const quarter = document.getElementById('quarterSelect').value;
            const year = document.getElementById('yearSelect').value;

            try {
                showNotification('Generating quarterly assessment report...', 'info');
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/reports/assessments/quarterly?quarter=${quarter}&year=${year}&format=${format}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `assessment-report-${quarter}-${year}.${format === 'pdf' ? 'pdf' : 'xls'}`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    showNotification('Assessment report generated successfully!', 'success');
                } else {
                    showNotification('Failed to generate assessment report', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('Network error generating report', 'error');
            }
        }

        async function generateEmployeeHistory(format) {
            const employeeId = document.getElementById('employeeIdInput').value;
            if (!employeeId) {
                showNotification('Please enter an Employee ID', 'warning');
                return;
            }

            try {
                showNotification('Generating employee assessment history...', 'info');
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/reports/employees/${employeeId}/assessments?format=${format}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `employee-history-${employeeId}.${format === 'pdf' ? 'pdf' : 'xls'}`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    showNotification('Employee history report generated successfully!', 'success');
                } else {
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    showNotification('Failed to generate employee history report: ' + (errorText || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('Network error generating report: ' + error.message, 'error');
            }
        }

        function generateCurrentQuarterReport() {
            document.getElementById('quarterSelect').value = 'Q4';
            document.getElementById('yearSelect').value = '2025';
            generateQuarterlyReport('pdf');
        }

        async function generateTaskReport(format) {
            try {
                showNotification('Generating task report...', 'info');
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/reports/tasks?format=${format}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `task-report.${format === 'pdf' ? 'pdf' : 'xls'}`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    showNotification('Task report generated successfully!', 'success');
                } else {
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    showNotification('Failed to generate task report: ' + (errorText || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('Network error generating report: ' + error.message, 'error');
            }
        }

        async function generateEmployeeTaskHistory(format) {
            const employeeId = document.getElementById('taskEmployeeIdInput').value;
            if (!employeeId) {
                showNotification('Please enter an Employee ID', 'warning');
                return;
            }

            try {
                showNotification('Generating employee task history...', 'info');
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/reports/employees/${employeeId}/tasks?format=${format}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `employee-task-history-${employeeId}.${format === 'pdf' ? 'pdf' : 'xls'}`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    showNotification('Employee task history report generated successfully!', 'success');
                } else {
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    showNotification('Failed to generate task history report: ' + (errorText || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('Network error generating report: ' + error.message, 'error');
            }
        }

        async function loadAnalytics() {
            const quarter = 'Q4'; // Current quarter
            const year = 2025;

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/reports/analytics/assessments?quarter=${quarter}&year=${year}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const analytics = await response.json();
                    displayAnalytics(analytics);
                    document.getElementById('analyticsSection').style.display = 'block';
                    showNotification('Analytics loaded successfully!', 'success');
                } else {
                    showNotification('Failed to load analytics', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('Network error loading analytics', 'error');
            }
        }

        function displayAnalytics(analytics) {
            // Display statistics cards
            const statsContainer = document.getElementById('analyticsStats');
            statsContainer.innerHTML = `
                <div class="stat-card">
                    <h3>${analytics.totalAttempts}</h3>
                    <p><i class="fas fa-clipboard-list"></i> Total Attempts</p>
                </div>
                <div class="stat-card success">
                    <h3>${analytics.passedAttempts}</h3>
                    <p><i class="fas fa-check-circle"></i> Passed</p>
                </div>
                <div class="stat-card danger">
                    <h3>${analytics.failedAttempts}</h3>
                    <p><i class="fas fa-times-circle"></i> Failed</p>
                </div>
                <div class="stat-card">
                    <h3>${analytics.averageScore}%</h3>
                    <p><i class="fas fa-percent"></i> Average Score</p>
                </div>
            `;

            // Score distribution chart
            const scoreCtx = document.getElementById('scoreDistributionChart').getContext('2d');
            const scoreChart = new Chart(scoreCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(analytics.scoreDistribution),
                    datasets: [{
                        label: 'Number of Students',
                        data: Object.values(analytics.scoreDistribution),
                        backgroundColor: [
                            '#27ae60', '#2ecc71', '#f39c12', '#e67e22', '#e74c3c'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });

            // Department performance chart
            const deptCtx = document.getElementById('departmentChart').getContext('2d');
            const deptChart = new Chart(deptCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(analytics.departmentPerformance),
                    datasets: [{
                        data: Object.values(analytics.departmentPerformance),
                        backgroundColor: [
                            '#3498db', '#9b59b6', '#1abc9c', '#f39c12', '#e74c3c'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }
    </script>

    <!-- Common Scripts -->
    <div th:replace="~{layout/admin-layout :: common-scripts}"></div>
</body>
</html>